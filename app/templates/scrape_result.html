<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraping Ergebnisse (Level 1 Links)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/scrape_result.css', v=version) }}">
</head>
<body>

    <!-- Navbar -->
    <div class="navbar">
        Scraping Ergebnisse
    </div>

    <div class="container">
        <!-- Container für die Liste -->
        <div class="list-container">
            <h2>Liste der Links</h2>
            <table>
                <thead>
                    <tr>
                        <th>Link</th>
                        <th>Auswahl</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page_id, page_data in url_mapping.items() %}
                        {% if page_data.level == 1 %}
                        <tr class="parent-row">
                            <td>
                                {% if page_data.children|length > 0 %}
                                <!-- Zeige den Toggle-Pfeil nur, wenn es Kinder gibt -->
                                <span class="toggle-btn-label" data-page-id="{{ page_id }}"></span>
                                {% endif %}
                                <a href="{{ page_data.url }}" class="toggle-link" target="_blank" data-page-id="{{ page_id }}">{{ page_data.title }} ({{ page_id }})</a>
                            </td>
                            <td><input type="checkbox" name="selected_links" value="{{ page_data.url }}"></td>
                        </tr>
                        <!-- Kinder-Elemente -->
                        {% for child_id in page_data.children %}
                            {% if child_id in url_mapping %}
                            <tr class="child-row child-of-{{ page_id }}">
                                <td style="padding-left: 40px;">
                                    <a href="{{ url_mapping[child_id].url }}" class="toggle-link" target="_blank">{{ url_mapping[child_id].title }} ({{ child_id }})</a>
                                </td>
                                <td><input type="checkbox" name="selected_links" value="{{ url_mapping[child_id].url }}"></td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Container für die ausgewählten Links -->
        <div class="selected-links-container">
            <h2>Ausgewählte Links</h2>
            <!-- Hier werden die ausgewählten Links angezeigt -->
            <div id="selected-links">
                <!-- Dynamischer Inhalt -->
            </div>

            <!-- Screenshot-Button -->
            <button id="screenshot-button" onclick="takeScreenshot()">Screenshots erstellen</button>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function () {
    const toggleButtons = document.querySelectorAll('.toggle-btn-label');
    const toggleLinks = document.querySelectorAll('.toggle-link');
    const selectedLinksContainer = document.getElementById('selected-links');

    toggleButtons.forEach(button => {
        button.addEventListener('click', function () {
            const pageId = this.getAttribute('data-page-id');
            toggleChildren(pageId, this);
        });
    });

    toggleLinks.forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault(); // Verhindere das Standardverhalten
            const pageUrl = this.getAttribute('data-page-url');

            // Öffne das Fenster in der rechten Bildschirmhälfte
            const width = window.screen.width / 2;
            const height = window.screen.height;
            const newWindow = window.open(pageUrl, '_blank', `width=${width},height=${height},left=${width},top=0`);

            // Füge den ausgewählten Link zum rechten Container hinzu
            const selectedLink = document.createElement('div');
            selectedLink.textContent = pageUrl;
            selectedLinksContainer.appendChild(selectedLink);
        });
    });

    function toggleChildren(pageId, toggleElement) {
        const childRows = document.querySelectorAll('.child-of-' + pageId);

        childRows.forEach(row => {
            if (row.style.display === 'none' || row.style.display === '') {
                row.style.display = 'table-row';
                if (toggleElement) toggleElement.classList.add('expanded');
            } else {
                row.style.display = 'none';
                if (toggleElement) toggleElement.classList.remove('expanded');
            }
        });
    }
});
    function takeScreenshot() {
        const checkboxes = document.querySelectorAll('input[name="selected_links"]:checked');
        let selectedLinks = [];

        checkboxes.forEach((checkbox) => {
            selectedLinks.push(checkbox.value);
        });

        if (selectedLinks.length === 0) {
            alert('Bitte wählen Sie mindestens einen Link aus.');
            return;
        }

        // AJAX-Anfrage, um die ausgewählten Links an den Server zu senden
        fetch('/start_screenshot_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ selected_links: selectedLinks }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.task_id) {
                // Weiterleitung zur Screenshot-Statusseite mit der task_id
                window.location.href = `/screenshot_result/${data.task_id}`;
            } else {
                alert('Fehler beim Starten des Screenshot-Tasks.');
            }
        })
        .catch(error => {
            console.error('Fehler beim Erstellen des Screenshot-Tasks:', error);
            alert('Es gab ein Problem beim Erstellen der Screenshots.');
        });
    }
</script>

</body>
</html>
