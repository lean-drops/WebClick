<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraping Ergebnisse (Level 1 Links)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/scrape_result.css', v=version) }}">
</head>
<body>

    <!-- Navbar -->
    <header class="navbar">
        <div>Scraping Ergebnisse</div>
        <!-- Zurück zum Index Button -->
        <a href="{{ url_for('main.index') }}" class="back-button">Zurück zum Index</a>
    </header>

    <main class="container">
        <!-- Container für die Liste -->
        <div class="list-container">
            <h2>Liste der Links</h2>
            <table>
                <thead>
                    <tr>
                        <th>Link</th>
                        <th>Auswahl</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page_id, page_data in url_mapping.items() %}
                        {% if page_data.level == 1 %}
                        <tr class="parent-row">
                            <td>
                                {% if page_data.children|length > 0 %}
                                <!-- Zeige den Toggle-Pfeil nur, wenn es Kinder gibt -->
                                <span class="toggle-btn-label" data-page-id="{{ page_id }}" role="button" aria-expanded="false" aria-controls="child-{{ page_id }}"></span>
                                {% endif %}
                                <!-- Entfernt target="_blank" -->
                                <a href="{{ page_data.url }}" class="toggle-link" data-page-id="{{ page_id }}">{{ page_data.title }}</a>
                            </td>
                            <td><input type="checkbox" name="selected_links" value="{{ page_data.url }}"></td>
                        </tr>
                        <!-- Kinder-Elemente -->
                        {% for child_id in page_data.children %}
                            {% if child_id in url_mapping %}
                            <tr class="child-row child-of-{{ page_id }}" id="child-{{ page_id }}" style="display: none;">
                                <td style="padding-left: 40px;">
                                    <!-- Entfernt target="_blank" -->
                                    <a href="{{ url_mapping[child_id].url }}" class="toggle-link" data-page-id="{{ page_id }}">{{ url_mapping[child_id].title }}</a>
                                </td>
                                <td><input type="checkbox" name="selected_links" value="{{ url_mapping[child_id].url }}"></td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Container für die ausgewählten Links -->
        <div class="selected-links-container">
            <h2>Ausgewählte Links</h2>
            <!-- Hier werden die ausgewählten Links angezeigt -->
            <div id="selected-links">
                <!-- Dynamischer Inhalt -->
            </div>

            <!-- Konvertieren-Button -->
            <button id="convert-button" onclick="startPdfConversion()">PDF-Konvertierung starten</button>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButtons = document.querySelectorAll('.toggle-btn-label');
            const selectedLinksContainer = document.getElementById('selected-links');
            const checkboxes = document.querySelectorAll('input[name="selected_links"]');
            const listLinks = document.querySelectorAll('.toggle-link'); // Auswahl für die List Links

            // Event-Listener für Toggle-Buttons
            toggleButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const pageId = this.getAttribute('data-page-id');
                    toggleChildren(pageId, this);
                });
            });

            // Event-Listener für Checkboxen
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const linkUrl = this.value;
                    const linkId = `selected-${hashCode(linkUrl)}`;

                    if (this.checked) {
                        // Link hinzufügen
                        const linkDiv = document.createElement('div');
                        linkDiv.classList.add('selected-link');
                        linkDiv.id = linkId;

                        const linkAnchor = document.createElement('a');
                        linkAnchor.href = linkUrl;
                        linkAnchor.textContent = linkUrl;
                        linkAnchor.addEventListener('click', function(e) {
                            e.preventDefault();
                            openWindowHalfScreen(linkUrl);
                        });

                        const removeButton = document.createElement('button');
                        removeButton.classList.add('remove-link');
                        removeButton.innerHTML = '&times;';
                        removeButton.addEventListener('click', function() {
                            checkbox.checked = false; // Checkbox deaktivieren
                            selectedLinksContainer.removeChild(linkDiv);
                        });

                        linkDiv.appendChild(linkAnchor);
                        linkDiv.appendChild(removeButton);
                        selectedLinksContainer.appendChild(linkDiv);
                    } else {
                        // Link entfernen
                        const linkDiv = document.getElementById(linkId);
                        if (linkDiv) {
                            selectedLinksContainer.removeChild(linkDiv);
                        }
                    }
                });
            });

            // Event-Listener für die List Links
            listLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault(); // Verhindert das Standardverhalten
                    const url = this.href;
                    openWindowHalfScreen(url);
                });
            });

            function toggleChildren(pageId, toggleElement) {
                const childRows = document.querySelectorAll('.child-of-' + pageId);
                const isExpanded = toggleElement.classList.toggle('expanded');
                toggleElement.setAttribute('aria-expanded', isExpanded);

                childRows.forEach(row => {
                    row.style.display = isExpanded ? 'table-row' : 'none';
                });
            }

            // Funktion zur Generierung eines einfachen Hashcodes für eindeutige IDs
            function hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = (hash << 5) - hash + str.charCodeAt(i);
                    hash |= 0; // Convert to 32bit integer
                }
                return Math.abs(hash).toString();
            }

            // Funktion zum Öffnen eines Fensters, das die rechte Hälfte des Bildschirms abdeckt
            function openWindowHalfScreen(url) {
                const width = Math.floor(window.screen.width / 2);
                const height = window.screen.height;
                const left = width;
                const top = 0;
                const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`;

                window.open(url, '_blank', features);
            }
        });

        async function startPdfConversion() {
            const checkboxes = document.querySelectorAll('input[name="selected_links"]:checked');
            let selectedLinks = [];

            checkboxes.forEach((checkbox) => {
                console.log(`Checkbox Wert: ${checkbox.value}`);  // Debugging
                selectedLinks.push(checkbox.value);
            });

            if (selectedLinks.length === 0) {
                alert('Bitte wählen Sie mindestens einen Link aus.');
                return;
            }

            // Ladeanzeige einblenden
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loading-indicator';
            loadingIndicator.textContent = 'Starte PDF-Konvertierung...';
            document.body.appendChild(loadingIndicator);

            try {
                console.log('Sende AJAX-Anfrage an /start_pdf_task');
                const response = await fetch('/start_pdf_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ selected_links: selectedLinks }),
                });

                const data = await response.json();
                console.log('Antwort erhalten, überprüfe den Status', data);

                if (data.status === 'success' && data.task_id) {
                    // Weiterleitung zur PDF-Statusseite mit der task_id
                    const taskId = data.task_id;
                    window.location.href = `/pdf_status/${taskId}`;
                } else {
                    document.body.removeChild(loadingIndicator);
                    alert('Fehler beim Starten des PDF-Tasks.');
                }
            } catch (error) {
                document.body.removeChild(loadingIndicator);
                console.error('Fehler beim Erstellen des PDF-Tasks:', error);
                alert('Es gab ein Problem beim Starten der PDF-Konvertierung.');
            }
        }

    </script>

</body>
</html>
